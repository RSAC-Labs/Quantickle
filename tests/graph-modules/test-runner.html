<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Modules Test Runner</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            text-align: center;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #005a87;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        #console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', monospace;
            padding: 15px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .test-progress {
            background: #e9ecef;
            border-radius: 4px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .test-progress-bar {
            background: #28a745;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        .module-status {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .module-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            text-align: center;
            min-width: 150px;
        }
        
        .module-card.tested {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .module-card.failed {
            border-color: #dc3545;
            background: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Graph Modules Test Runner</h1>
        
        <div class="controls">
            <button id="run-all-tests" onclick="runAllTests()">Run All Tests</button>
            <button id="run-background-grid" onclick="runBackgroundGridTests()">Test Background Grid</button>
            <button id="run-debug-tools" onclick="runDebugToolsTests()">Test Debug Tools</button>
            <button id="run-performance-manager" onclick="runPerformanceManagerTests()">Test Performance Manager</button>
            <button id="clear-console" onclick="clearConsole()">Clear Console</button>
            <button id="test-adapter" onclick="testAdapter()">Test Adapter</button>
        </div>
        
        <div id="status" class="status loading">Ready to run tests...</div>
        
        <div class="test-progress">
            <div id="progress-bar" class="test-progress-bar">0%</div>
        </div>
        
        <div class="module-status">
            <div id="background-grid-status" class="module-card">
                <h4>Background Grid</h4>
                <div>Status: <span id="bg-status">Not Tested</span></div>
                <div>Tests: <span id="bg-tests">0/0</span></div>
            </div>
            
            <div id="debug-tools-status" class="module-card">
                <h4>Debug Tools</h4>
                <div>Status: <span id="dt-status">Not Tested</span></div>
                <div>Tests: <span id="dt-tests">0/0</span></div>
            </div>
            
            <div id="performance-status" class="module-card">
                <h4>Performance Manager</h4>
                <div>Status: <span id="pm-status">Not Tested</span></div>
                <div>Tests: <span id="pm-tests">0/0</span></div>
            </div>
        </div>
    </div>
    
    <div class="test-container">
        <h3>Console Output</h3>
        <div id="console-output"></div>
    </div>

    <!-- Load Cytoscape.js for integration tests -->
    <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.30.1/dist/cytoscape.min.js"></script>
    
    <!-- Load our testing framework -->
    <script src="test-framework.js"></script>
    
    <!-- Load modules to test -->
    <script src="../../js/features/graph-modules/background-grid/background-grid-module.js"></script>
    <script src="../../js/features/graph-modules/background-grid/adapter.js"></script>
    <script src="../../js/features/graph-modules/debug-tools/debug-tools-module.js"></script>
    <script src="../../js/features/graph-modules/debug-tools/adapter.js"></script>
    <script src="../../js/features/graph-modules/performance-manager/performance-manager-module.js"></script>
    <script src="../../js/features/graph-modules/performance-manager/bootstrap.js"></script>
    
    <!-- Load test suites -->
    <script src="background-grid.test.js"></script>
    <script src="debug-tools.test.js"></script>
    <script src="performance-manager.test.js"></script>

    <script>
        // Capture console output
        let consoleOutput = null;
        
        // Initialize console output when DOM is ready
        function initConsoleOutput() {
            consoleOutput = document.getElementById('console-output');
            if (!consoleOutput) {
                console.warn('Console output element not found');
            }
        }
        
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        function appendToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'color: #ff6b6b' : 
                              type === 'warn' ? 'color: #ffa726' : 
                              type === 'success' ? 'color: #4caf50' : 'color: #d4d4d4';
            
            if (consoleOutput) {
                consoleOutput.innerHTML += `<span style="${colorClass}">[${timestamp}] ${message}</span>\n`;
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
        }
        
        console.log = function(...args) {
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            appendToConsole(message, 'log');
            originalConsoleLog.apply(console, args);
        };
        
        console.error = function(...args) {
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            appendToConsole('ERROR: ' + message, 'error');
            originalConsoleError.apply(console, args);
        };
        
        console.warn = function(...args) {
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            appendToConsole('WARN: ' + message, 'warn');
            originalConsoleWarn.apply(console, args);
        };
        
        // Test runner functions
        function updateStatus(message, type = 'loading') {
            const statusEl = document.getElementById('status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `status ${type}`;
            } else {
                console.log(`Status: ${message} (${type})`);
            }
        }
        
        function updateProgress(percent) {
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.width = `${percent}%`;
                progressBar.textContent = `${Math.round(percent)}%`;
            } else {
                console.log(`Progress: ${Math.round(percent)}%`);
            }
        }
        
        function updateModuleStatus(module, status, passedTests, totalTests) {
            const statusEl = document.getElementById(`${module}-status`);
            if (!statusEl) {
                console.log(`Module ${module}: ${status} (${passedTests}/${totalTests})`);
                return;
            }
            
            const prefix = module.includes('background') ? 'bg' : 
                          module.includes('debug') ? 'dt' : 'pm';
            
            const statusSpan = statusEl.querySelector(`#${prefix}-status`);
            const testsSpan = statusEl.querySelector(`#${prefix}-tests`);
            
            if (statusSpan) statusSpan.textContent = status;
            if (testsSpan) testsSpan.textContent = `${passedTests}/${totalTests}`;
            
            if (status === 'Passed') {
                statusEl.className = 'module-card tested';
            } else if (status === 'Failed') {
                statusEl.className = 'module-card failed';
            }
        }
        
        function clearConsole() {
            if (consoleOutput) {
                consoleOutput.innerHTML = '';
            }
        }
        
        async function runAllTests() {
            console.log('üöÄ Starting test execution...');
            updateStatus('Running all tests...', 'loading');
            updateProgress(0);
            
            try {
                // Ensure test framework is available
                if (!window.GraphTestFramework) {
                    throw new Error('Test framework not loaded');
                }
                
                // Reset test results
                window.GraphTestFramework.testResults = [];
                
                // Run Background Grid tests
                updateProgress(25);
                console.log('Running Background Grid tests...');
                await runBackgroundGridTestsInternal();
                updateProgress(33);
                
                // Run Debug Tools tests
                updateModuleStatus('dt', 'Testing...', '', '#FFA500');
                await runDebugToolsTestsInternal();
                
                const dtResults = window.GraphTestFramework.getLastResults();
                const dtPassed = dtResults.passed;
                const dtTotal = dtResults.total;
                
                passedTests += dtPassed;
                totalTests += dtTotal;
                
                updateModuleStatus('dt',
                    dtPassed === dtTotal ? 'PASSED' : 'FAILED',
                    `${dtPassed}/${dtTotal}`,
                    dtPassed === dtTotal ? '#28a745' : '#dc3545'
                );
                
                updateProgress(50);
                
                // Run Performance Manager tests
                updateModuleStatus('pm', 'Testing...', '', '#FFA500');
                await runPerformanceManagerTestsInternal();
                
                const pmResults = window.GraphTestFramework.getLastResults();
                const pmPassed = pmResults.passed;
                const pmTotal = pmResults.total;
                
                passedTests += pmPassed;
                totalTests += pmTotal;
                
                updateModuleStatus('pm',
                    pmPassed === pmTotal ? 'PASSED' : 'FAILED',
                    `${pmPassed}/${pmTotal}`,
                    pmPassed === pmTotal ? '#28a745' : '#dc3545'
                );
                
                updateProgress(80);
                
                // Future tests would go here
                updateProgress(100);
                
                updateStatus('All tests completed!', 'success');
                console.log('‚úÖ All tests completed successfully');
            } catch (error) {
                updateStatus(`Tests failed: ${error.message}`, 'error');
                console.error('‚ùå Test suite failed:', error);
                console.error('Error stack:', error.stack);
            }
        }
        
        async function runBackgroundGridTestsInternal() {
            console.log('üß™ Starting Background Grid Module Tests...');
            
            try {
                // Ensure test framework and modules are available
                if (!window.GraphTestFramework) {
                    throw new Error('GraphTestFramework not available');
                }
                
                if (!window.BackgroundGridModule) {
                    throw new Error('BackgroundGridModule not loaded');
                }
                
                // Clear previous results
                window.GraphTestFramework.testResults = [];
                
                // Manually trigger test execution
                console.log('Executing background grid tests...');
                
                // Check if the test function exists and run it
                if (typeof runBackgroundGridTests === 'function') {
                    runBackgroundGridTests();
                } else {
                    console.log('Test function not found, running inline...');
                    
                    // Simple inline test to verify functionality
                    window.GraphTestFramework.describe('BackgroundGridModule Basic Test', () => {
                        window.GraphTestFramework.it('should be available', () => {
                            window.GraphTestFramework.expect(window.BackgroundGridModule).toBeTruthy();
                        });
                        
                        window.GraphTestFramework.it('should create instance', () => {
                            const mockDeps = window.GraphTestFramework.createMockModule();
                            const instance = new BackgroundGridModule(mockDeps);
                            window.GraphTestFramework.expect(instance).toBeInstanceOf(BackgroundGridModule);
                            instance.destroy();
                        });
                    });
                }
                
                // Wait for tests to complete
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (window.GraphTestFramework.testResults.length > 0) {
                    const results = window.GraphTestFramework.printOverallResults();
                    
                    updateModuleStatus('background-grid', 
                        results.failed === 0 ? 'Passed' : 'Failed',
                        results.passed, 
                        results.tests
                    );
                    
                    if (results.failed === 0) {
                        console.log('‚úÖ Background Grid tests PASSED');
                    } else {
                        console.error('‚ùå Background Grid tests FAILED');
                    }
                } else {
                    console.warn('‚ö†Ô∏è No test results found, but no errors occurred');
                    updateModuleStatus('background-grid', 'Unknown', 0, 0);
                }
                
            } catch (error) {
                console.error('Background Grid test execution failed:', error);
                updateModuleStatus('background-grid', 'Failed', 0, 0);
                throw error;
            }
        }
        
        async function runDebugToolsTestsInternal() {
            console.log('üß™ Starting Debug Tools Module Tests...');
            
            try {
                // Ensure test framework and modules are available
                if (!window.GraphTestFramework) {
                    throw new Error('GraphTestFramework not available');
                }
                
                if (!window.DebugToolsModule) {
                    throw new Error('DebugToolsModule not loaded');
                }
                
                // Clear previous results
                window.GraphTestFramework.testResults = [];
                
                // Manually trigger test execution
                console.log('Executing debug tools tests...');
                
                // Check if the test function exists and run it
                if (typeof runDebugToolsTests === 'function') {
                    runDebugToolsTests();
                } else {
                    console.log('Test function not found, running inline...');
                    
                    // Simple inline test to verify functionality
                    window.GraphTestFramework.describe('DebugToolsModule Basic Test', () => {
                        window.GraphTestFramework.it('should be available', () => {
                            window.GraphTestFramework.expect(window.DebugToolsModule).toBeTruthy();
                        });
                        
                        window.GraphTestFramework.it('should create instance', () => {
                            const mockDeps = window.GraphTestFramework.createMockModule();
                            const instance = new DebugToolsModule(mockDeps);
                            window.GraphTestFramework.expect(instance).toBeInstanceOf(DebugToolsModule);
                            instance.destroy();
                        });
                    });
                }
                
                // Wait for tests to complete
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (window.GraphTestFramework.testResults.length > 0) {
                    const results = window.GraphTestFramework.printOverallResults();
                    
                    updateModuleStatus('debug-tools', 
                        results.failed === 0 ? 'Passed' : 'Failed',
                        results.passed, 
                        results.tests
                    );
                } else {
                    updateModuleStatus('debug-tools', 'No Results', '0', '0');
                    appendToConsole('‚ö†Ô∏è No test results found for Debug Tools\n');
                }
                
            } catch (error) {
                console.error('Debug Tools tests failed:', error);
                updateModuleStatus('debug-tools', 'Error', '0', '0');
                appendToConsole(`‚ùå Debug Tools test error: ${error.message}\n`);
                throw error;
            }
        }
        
        async function runDebugToolsTests() {
            updateStatus('Testing Debug Tools Module...', 'loading');
            
            try {
                await runDebugToolsTestsInternal();
                updateStatus('Debug Tools tests completed', 'success');
            } catch (error) {
                updateStatus('Debug Tools tests failed: ' + error.message, 'error');
                console.error('Debug Tools test error:', error);
            }
        }
        
        async function runPerformanceManagerTestsInternal() {
            console.log('üß™ Starting Performance Manager Module Tests...');
            
            try {
                // Ensure test framework and modules are available
                if (!window.GraphTestFramework) {
                    throw new Error('GraphTestFramework not available');
                }
                
                if (!window.PerformanceManagerModule) {
                    throw new Error('PerformanceManagerModule not loaded');
                }
                
                // Clear previous results
                window.GraphTestFramework.testResults = [];
                
                // Manually trigger test execution
                console.log('Executing performance manager tests...');
                
                // Check if the test function exists and run it
                if (typeof runPerformanceManagerTests === 'function') {
                    runPerformanceManagerTests();
                } else {
                    console.log('Test function not found, running inline...');
                    
                    // Simple inline test to verify functionality
                    window.GraphTestFramework.describe('PerformanceManagerModule Basic Test', () => {
                        window.GraphTestFramework.it('should be available', () => {
                            window.GraphTestFramework.expect(window.PerformanceManagerModule).toBeTruthy();
                        });
                        
                        window.GraphTestFramework.it('should create instance', () => {
                            const mockDeps = window.GraphTestFramework.createMockModule();
                            const instance = new PerformanceManagerModule(mockDeps);
                            window.GraphTestFramework.expect(instance).toBeInstanceOf(PerformanceManagerModule);
                            instance.destroy();
                        });
                    });
                }
                
                // Wait for tests to complete
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (window.GraphTestFramework.testResults.length > 0) {
                    const results = window.GraphTestFramework.printOverallResults();
                    
                    updateModuleStatus('performance-manager', 
                        results.failed === 0 ? 'Passed' : 'Failed',
                        results.passed, 
                        results.tests
                    );
                } else {
                    updateModuleStatus('performance-manager', 'No Results', '0', '0');
                    appendToConsole('‚ö†Ô∏è No test results found for Performance Manager\n');
                }
                
            } catch (error) {
                console.error('Performance Manager tests failed:', error);
                updateModuleStatus('performance-manager', 'Error', '0', '0');
                appendToConsole(`‚ùå Performance Manager test error: ${error.message}\n`);
                throw error;
            }
        }
        
        async function runPerformanceManagerTests() {
            updateStatus('Testing Performance Manager Module...', 'loading');
            
            try {
                await runPerformanceManagerTestsInternal();
                updateStatus('Performance Manager tests completed', 'success');
            } catch (error) {
                updateStatus('Performance Manager tests failed: ' + error.message, 'error');
                console.error('Performance Manager test error:', error);
            }
        }
        
        async function runBackgroundGridTests() {
            updateStatus('Testing Background Grid Module...', 'loading');
            
            try {
                await runBackgroundGridTestsInternal();
                updateStatus('Background Grid tests completed!', 'success');
            } catch (error) {
                updateStatus(`Background Grid tests failed: ${error.message}`, 'error');
            }
        }
        
        function testAdapter() {
            console.log('üîß Testing Background Grid Adapter...');
            
            try {
                if (window.BackgroundGridAdapter) {
                    const status = window.BackgroundGridAdapter.getStatus();
                    console.log('Adapter Status:', status);
                    
                    if (window.BackgroundGridAdapter.moduleInstance) {
                        const testResult = window.BackgroundGridAdapter.testModularVersion();
                        console.log('Adapter Test Result:', testResult ? 'PASSED' : 'FAILED');
                        
                        if (testResult) {
                            updateStatus('Adapter test passed!', 'success');
                        } else {
                            updateStatus('Adapter test failed!', 'error');
                        }
                    } else {
                        updateStatus('Adapter module not available', 'error');
                    }
                } else {
                    updateStatus('Adapter not loaded', 'error');
                }
            } catch (error) {
                console.error('Adapter test failed:', error);
                updateStatus(`Adapter test error: ${error.message}`, 'error');
            }
        }
        
        // Auto-run tests when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize console output
            initConsoleOutput();
            
            console.log('üöÄ Graph Modules Test Runner loaded');
            console.log('Click "Run All Tests" to start testing');
            
            // Check if modules are loaded
            setTimeout(() => {
                if (window.BackgroundGridModule) {
                    console.log('‚úÖ BackgroundGridModule loaded');
                } else {
                    console.error('‚ùå BackgroundGridModule not loaded');
                }
                
                if (window.BackgroundGridAdapter) {
                    console.log('‚úÖ BackgroundGridAdapter loaded');
                } else {
                    console.error('‚ùå BackgroundGridAdapter not loaded');
                }
                
                if (window.GraphTestFramework) {
                    console.log('‚úÖ GraphTestFramework loaded');
                } else {
                    console.error('‚ùå GraphTestFramework not loaded');
                }
                
                updateStatus('Ready to run tests...', 'loading');
            }, 500);
        });
    </script>
</body>
</html>
